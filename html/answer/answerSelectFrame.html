<!doctype html>
<html>
<head>
    <meta charset="UTF-8">
    <meta name="viewport"
          content="maximum-scale=1.0,minimum-scale=1.0,user-scalable=0,width=device-width,initial-scale=1.0"/>
    <meta name="format-detection" content="telephone=no,email=no,date=no,address=no">
    <title></title>
    <link rel="stylesheet" type="text/css" href="../../css/api.css"/>
    <link rel="stylesheet" type="text/css" href="../../css/aui.css"/>
    <style>
        #selectContainer {
            width: 100%;
            height: auto;
            padding: 10px;
            display: -webkit-box;
            text-align: center;
        }

        #hot {
            width: 80px;
            height: 80px;
            line-height: 80px;
            border: solid 1px #c8c8c8;
        }

        #normal {
            height: 80px;
            line-height: 40px;
            -webkit-box-flex: 1;
            display: -webkit-box;
            -webkit-box-orient: vertical;
            border-top: solid 1px #c8c8c8;
            border-right: solid 1px #c8c8c8;
            border-bottom: solid 1px #c8c8c8;
        }

        #normalTop {
            height: 50%;
            width: 100%;
            display: -webkit-box;
            border-bottom: solid 1px #c8c8c8;
        }

        #exam {
            width: 100%;
            height: 100%;
        }

        #random {
            width: 50%;
            height: 100%;
            border-right: solid 1px #c8c8c8;
        }

        #unit {
            width: 50%;
            height: 100%;
        }

        #composite {
            width: 100%;
            height: 50%;
            margin-bottom: 4px;
        }

        .blockActive {
            color: #fff;
            background-color: #666666;
        }
    </style>
</head>
<body>
<header class="aui-bar aui-bar-nav aui-bar-info">
    <a class="aui-pull-left">
        <span class="aui-iconfont aui-icon-left" onclick="CloseWin()"></span>
    </a>

    <div class="aui-title" onclick="SwitchType();">
        分类选择
        <i class="aui-iconfont aui-icon-unfold" style="font-size: 14px"></i>
    </div>
</header>
<div id="main">
    <div id="document">
        <ul class="aui-list-view">
            <li class="aui-list-view-cell" onclick="OpenDoucment()">
                <a class="aui-arrow-right">
                    <i class="aui-iconfont aui-icon-file"></i>参考资料
                </a>
            </li>
        </ul>
    </div>
    <div id="selectContainer">
        <div id="hot">
            <div id="exam" tapmode="blockActive" onclick="GenerateExamTest();">真题检测</div>
        </div>
        <div id="normal">
            <div id="normalTop">
                <div id="random" tapmode="blockActive" onclick="GenerateRandomTest();">随便做做</div>
                <div id="unit" tapmode="blockActive" onclick="GenerateUnitTest();">章节练习</div>
            </div>
            <div id="composite" tapmode="blockActive" onclick="GenerateSimulationTest();">模拟练习</div>
        </div>
    </div>
</div>
</body>
<script type="text/javascript" src="../../script/api.js"></script>
<script type="text/javascript">
    var questionTypeId, questionTypeName;
    var allTypeList = [];
    var currentTypeDocument = [];
    apiready = function () {
        var pageParam = api.pageParam;
        var typeId = pageParam.typeId;
        var typeName = pageParam.typeName;
        allTypeList = pageParam.allTypeList;
        //标题
        $api.fixStatusBar($api.dom('header'));
        SetTitle(typeName);
        GetDocumentNum(typeName);
        questionTypeId = typeId;
        questionTypeName = typeName;
    };
    //生成试卷
    function GenerateRandomTest() {
        //随便做做
        api.showProgress({
            style: 'default',
            animationType: 'fade',
            title: '努力加载中...',
            text: '先喝杯茶...'
        });

        var relation_m = api.require('relation');
        relation_m.findAll({
            class: 'QuestionType',
            id: questionTypeId,
            column: 'unclassifiedQuestions'
        },function(ret,err){
            if(ret){
                if(ret.length > 0){
                    api.openWin({
                        name: 'testPaperFrame',
                        url: './testPaperFrame.html',
                        pageParam: {
                            testName: '随便做做',
                            testQuestion: ret
                        },
                        slidBackEnabled: false
                    });
                }else{
                    api.toast({ msg: '没有题目'});
                }
            }else{
                api.toast({ msg: '获取题目失败，请重试...'});
            }
        });
    }
    function GenerateUnitTest() {
        //单元测试
        api.showProgress({
            style: 'default',
            animationType: 'fade',
            title: '努力加载中...',
            text: '先喝杯茶...'
        });

        var relation_m = api.require('relation');
        relation_m.findAll({
            class: 'QuestionType',
            id: questionTypeId,
            column: 'chapter'
        }, function (ret, err) {
            api.hideProgress();
            if (ret) {
                var allChapterList = [];
                for (var i = 0; i < ret.length; i++) {
                    var dat = {
                        id: ret[i].id,
                        cname: ret[i].chapterName
                    };
                    allChapterList.push(dat);
                }

                api.openWin({
                    name: 'chapterSelectFrame',
                    url: './chapterSelectFrame.html',
                    pageParam: {
                        allChapterList: allChapterList
                    }
                });
            } else {
                api.toast({
                    msg: '获取章节失败，请重试...',
                    duration: 2000,
                    location: 'bottom'
                });
            }
        });
    }
    function GenerateSimulationTest() {
        //模拟练习
        api.openWin({
            name: 'simulationSelectFrame',
            url: './simulationSelectFrame.html',
            pageParam: {
                questionTypeId: questionTypeId,
                questionTypeName: questionTypeName
            }
        });
    }
    function GenerateExamTest() {
        //真题测试
        api.openWin({
            name: 'yearSelectFrame',
            url: './yearSelectFrame.html',
            pageParam: {
                questionTypeId: questionTypeId,
                questionTypeName: questionTypeName
            }
        });
    }

    //切换分类
    function SwitchType() {
        //切换分类
        var buttonList = [];
        for (var i = 0; i < allTypeList.length; i++) {
            buttonList[i] = allTypeList[i].name;
        }
        api.actionSheet({
            cancelTitle: '取消',
            buttons: buttonList
        }, function (ret, err) {
            var index = ret.buttonIndex;
            var item = allTypeList[index - 1];
            if (index <= allTypeList.length) {
                questionTypeId = item.id;
                SetTitle(item.name);
                GetDocumentNum(item.name);
            }
            else {
                //取消
            }
        });
    }
    //根据分类名重设标题
    function SetTitle(typeName) {
        var $title = $api.dom('header .aui-title');
        $api.html($title, typeName + ' - 分类选择' + '<i class="aui-iconfont aui-icon-unfold" style="font-size: 14px"></i>');
    }
    //获取资料数目
    function GetDocumentNum(typeName) {
        var query = api.require('query');
        query.createQuery(function (ret, err) {
            if (ret && ret.qid) {
                var queryId = ret.qid;
                query.whereLike({
                    qid: queryId,
                    column: 'name',
                    value: typeName
                });
                var model = api.require('model');
                model.findAll({
                    class: "DocumentType",
                    qid: queryId
                }, function (ret, err) {
                    if (ret) {
                        var count = 0;
                        for (var i = 0; i < ret.length; i++) {
                            var id = ret[i].id;
                            var relation_m = api.require('relation');
                            relation_m.findAll({
                                class: 'DocumentType',
                                id: id,
                                column: 'documents'
                            }, function (ret, err) {
                                if (ret) {
                                    count += ret.length;
                                    currentTypeDocument = ret;//将资料数据合并到当前的分类资料数组里

                                    var str = '';
                                    if (count > 0) {
                                        str += '<i class="aui-iconfont aui-icon-file"></i>参考资料<span class="aui-badge aui-badge-danger">' + count + '</span>';
                                    } else {
                                        str += '<i class="aui-iconfont aui-icon-file"></i>参考资料';
                                    }
                                    $api.html($api.dom('#document a'), str);
                                }
                            });
                        }
                    }
                    else {
                        alert('出现错误:' + JSON.stringify(err));
                    }
                });
            }
        });
    }
    //打开资料档
    function OpenDoucment() {
        api.openWin({
            name: 'documentList',
            url: '../document/documentList.html',
            pageParam: {
                documentList: currentTypeDocument
            }
        })
    }

    function CloseWin() {
        api.closeWin();
    }
</script>
</html>