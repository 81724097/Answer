<!doctype html>
<html>
<head>
    <meta charset="UTF-8">
    <meta name="viewport"
          content="maximum-scale=1.0,minimum-scale=1.0,user-scalable=0,width=device-width,initial-scale=1.0"/>
    <meta name="format-detection" content="telephone=no,email=no,date=no,address=no">
    <title></title>
    <link rel="stylesheet" type="text/css" href="../../css/api.css"/>
    <link rel="stylesheet" type="text/css" href="../../css/aui.css"/>
    <style>
        html, body {
            height: auto;
        }

        .circleHead {
            border-radius: 100%;
        }

        .circleHandleBlock {
            display: -webkit-box;
        }

        .circleHandleBlock .circleHandle {
            -webkit-box-flex: 1;
            padding: 6px 0;
            margin: auto 4px;
        }

        .topicon {
            background-color: #0062cc;
            float: left;
            color: #FFFFFF;
            padding: 0 4px;
            font-size: 12px;
            border-radius: 6px;
            margin: 3px 4px 3px 0;
        }

        .article {
            background-color: #FFFFFF;
            display: block;
            margin-bottom: 10px;
            border-top: 1px solid rgba(200, 199, 204, 0.5);
            border-bottom: 1px solid rgba(200, 199, 204, 0.5);
            padding: 12px 15px;
        }

        .articleInfo {
            display: -webkit-box;

        }

        .articleHead {
            width: 40px;
            height: 40px;
            margin-right: 10px;
        }

        .articleAuthor {
            -webkit-box-flex: 1;
            line-height: 40px;
            color: #c47c0c;
        }

        .articleTime {
            line-height: 40px;
        }

        .articleInteract {
            text-align: right;
        }

        .articleInteract div {
            display: inline-block;
        }
    </style>
</head>
<body>
<header class="aui-bar aui-bar-nav aui-bar-info">
    <a class="aui-pull-left">
        <span class="aui-iconfont aui-icon-left" onclick="api.closeWin()"></span>
    </a>

    <div class="aui-title">圈子</div>
    <a class="aui-pull-right">
        <span class="aui-iconfont aui-icon-edit"></span>
    </a>
</header>
<div class="aui-content">
    <ul class="aui-list-view">
        <li class="aui-list-view-cell aui-img">
            <img src="../../image/default_head.jpg" class="aui-img-object aui-pull-left circleHead">

            <div class="aui-img-body aui-arrow-right">
                <span>大学生自拍交友</span>

                <p>圈主:moonrailgun</p>

                <p>关注:999 帖子:233</p>
            </div>
        </li>
        <li class="aui-list-view-cell circleHandleBlock">
            <div class="aui-btn aui-btn-block aui-btn-danger circleHandle">
                <strong class="aui-iconfont aui-icon-add"></strong>关注
            </div>
            <div class="aui-btn aui-btn-block aui-btn-warning circleHandle">
                <strong class="aui-iconfont aui-icon-favor"></strong>精华
            </div>
            <div class="aui-btn aui-btn-block aui-btn-info circleHandle">
                <strong class="aui-iconfont aui-icon-emoji"></strong>签到
            </div>
        </li>
    </ul>
    <ul class="aui-list-view topArticle">
        <li class="aui-list-view-cell">
            <div class="topicon">置顶</div>
            <h2>圈规</h2>
        </li>
    </ul>
    <div id="articleList" class="articleList">

    </div>
</div>
</body>
<script type="text/javascript" src="../../script/api.js"></script>
<script type="text/javascript" src="../../script/utils.js"></script>
<script type="text/javascript">
    var defaultHeadImg = '../../image/default_head.jpg';
    var articleList = [];
    var circleId, circleName;
    apiready = function () {
        $api.fixStatusBar($api.dom('header'));//标题

        var pageParam = api.pageParam;
        circleId = pageParam.circleId;
        circleName = pageParam.circleName;

        GetArticleList(circleId);
    };

    function GetArticleList(circleId) {
        var query = api.require('query');
        query.createQuery(function (ret, err) {
            if (ret && ret.qid) {
                var queryId = ret.qid;
                query.whereEqual({qid: queryId, column: 'circleId', value: circleId});
                query.include({qid: queryId, column: 'authorId'});
                query.desc({qid: queryId, column: 'updatedAt'});
                query.limit({qid: queryId, value: 20});
                var model = api.require('model');
                model.findAll({
                    class: "CircleArticle",
                    qid: queryId
                }, function (ret, err) {
                    if (ret) {
                        for (var i = 0; i < ret.length; i++) {
                            var item = ret[i];
                            var article = {
                                id: item.id,
                                author: item.authorId.nickname,
                                headImg: item.authorId.avatar ? item.authorId.avatar.url : defaultHeadImg,
                                time: Utils.ParseTime(item.updatedAt),
                                title: item.articleTitle,
                                content: item.articleContent,
                                replyNum: 0,
                                likeNum: item.articleLikedUserId.length
                            };
                            articleList.push(article);
                            UpdateArticle();

                            (function(article,id){
                                var relation_m = api.require('relation');
                                relation_m.count({
                                    class: 'CircleArticle',
                                    id: id,
                                    column: 'articleReply'
                                }, function (ret, err) {
                                    if (ret) {
                                        article.replyNum = ret.count;
                                        UpdateArticle();
                                    }
                                });
                            })(article, item.id);
                        }
                    }
                });
            }
        });
    }

    function UpdateArticle(){
        $api.html($api.dom('#articleList'), '');
        for(var i = 0;i< articleList.length;i++){
            AddArticle(articleList[i]);
        }
    }

    function AddArticle(article) {
        var id = article.id;
        var author = article.author;
        var headImg = article.headImg || defaultHeadImg;
        var time = article.time;
        var title = article.title;
        var summmary = article.content;
        var firstImg = article.firstImg;
        var likeNum = article.likeNum;
        var replyNum = article.replyNum;

        var $articleList = $api.dom('#articleList');
        var str = '';
        str += '<div class="article" onclick=\'EnterArticle("'+id+'")\'><div class="articleInfo">' +
                '<img src="' + headImg + '" class="circleHead articleHead">' +
                '<div class="articleAuthor aui-ellipsis-1">' + author + '</div>' +
                '<p class="articleTime">' + time + '</p></div>' +
                '<div class="articleContent"><h1 class="articleTitle">' + title + '</h1>' +
                '<div class="articleContentSummary">' + summmary +
                (!!firstImg ? '<img width="100%" height="auto" src="' + firstImg + '"></div></div>' : '') +
                '<div class="articleInteract"><div class="articleLike"><i class="aui-iconfont aui-icon-like aui-text-blue"></i>' +
                '<span class="aui-text-default">' + likeNum + '</span></div>&nbsp;' +
                '<div class="articleReply"><i class="aui-iconfont aui-icon-message aui-text-blue"></i>' +
                '<span class="aui-text-default">' + replyNum + '</span></div></div></div>';
        $api.append($articleList, str);
    }

    function EnterArticle(articleId){
        api.openWin({
            name: 'circleArticle',
            url: './circleArticle.html',
            pageParam:{
                articleId: articleId,
                circleId: circleId,
                circleName: circleName
            }
        });
    }
</script>
</html>