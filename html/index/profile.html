<!doctype html>
<html>
<head>
    <meta charset="UTF-8">
    <meta name="viewport"
          content="maximum-scale=1.0,minimum-scale=1.0,user-scalable=0,width=device-width,initial-scale=1.0"/>
    <meta name="format-detection" content="telephone=no,email=no,date=no,address=no">
    <title>Hello APP</title>
    <link rel="stylesheet" type="text/css" href="../../css/api.css"/>
    <link rel="stylesheet" type="text/css" href="../../css/aui.css"/>
    <style>
        body {
            min-height: 100%;
            height: auto;
        }

        #userInfo {
            display: -webkit-box;
        }

        #userMain {
            -webkit-box-flex: 1;
            margin-left: 10px;
        }

        #username {
            font-size: 12px;
        }

        #userLeft {
            margin: 19px 20px 20px 0;
            width: 24px;
            height: 24px;
            font-size: 20px;
            color: #949494;
        }

        .liActive {
            background-color: #919191;
        }

        .aui-btn-block {
            border-radius: 0;
        }

        .infoBlock {
            width: 100%;
            display: -webkit-box;
        }

        .infoBlock .infoBlockCell {
            width: 50%;
            display: -webkit-box;
            -webkit-box-orient: vertical;
            text-align: center;
            font-size: 14px;
            line-height: 22px;
            color: #6d6d72;
        }

        .infoBlock .infoBlockCell .infoBlockCellNum {
            line-height: 42px;
            color: #fa6359;
            font-size: 32px;
        }
    </style>
</head>
<body>
<div class="aui-content">
    <ul class="aui-list-view">
        <li id="userInfo" class="aui-list-view-cell aui-img">
            <div id="userHead" onclick="ChangePic();"><img class="aui-img-object" src="../../image/default_head.jpg">
            </div>
            <div id="userMain" class="aui-img-body" onclick="OpenInfoWin();">
                <div id="nickname">游客</div>
                <div id="username">游客</div>
            </div>
            <div id="userLeft" class="aui-iconfont aui-icon-qrcode aui-arrow-right" onclick="OpenInfoWin();"></div>
        </li>
        <li class="infoBlock">
            <div id="score" tapmode="liActive" class="infoBlockCell" style="border-right: 1px solid #c8c7cc;">
                <div class="infoBlockCellNum">0</div>
                <div>积分</div>
            </div>
            <div id="rank" tapmode="liActive" class="infoBlockCell" onclick="SwitchToRank();">
                <div class="infoBlockCellNum">1</div>
                <div>排名</div>
            </div>
        </li>
    </ul>
    <ul class="aui-list-view">
        <li tapmode="liActive" class="aui-list-view-cell">
            <a class="aui-arrow-right" onclick="NoFunction();">我的红包</a>
        </li>
        <li tapmode="liActive" class="aui-list-view-cell">
            <a class="aui-arrow-right" onclick="NoFunction();">我的好友</a>
        </li>
        <li tapmode="liActive" class="aui-list-view-cell">
            <a id="favorite" class="aui-arrow-right" onclick="OpenFavoriteWin();">
                我的收藏
            </a>
        </li>
        <li tapmode="liActive" class="aui-list-view-cell">
            <a class="aui-arrow-right" onclick="ShowDownloadManager();">我的下载</a>
        </li>
    </ul>
    <ul class="aui-list-view">
        <li tapmode="liActive" class="aui-list-view-cell">
            <a class="aui-arrow-right" onclick="NoFunction();">资料库</a>
        </li>
        <li tapmode="liActive" class="aui-list-view-cell">
            <a class="aui-arrow-right" onclick="NoFunction();">学习圈</a>
        </li>
        <li tapmode="liActive" class="aui-list-view-cell">
            <a id="wrongSet" class="aui-arrow-right" onclick="OpenWrongSet();">错题集</a>
        </li>
        <li tapmode="liActive" class="aui-list-view-cell">
            <a class="aui-arrow-right" onclick="NoFunction();">计划</a>
        </li>
    </ul>
    <button class="aui-btn aui-btn-danger aui-btn-block" onclick="Logout()">退出登录</button>
</div>
</body>
<script type="text/javascript" src="../../script/api.js"></script>
<script type="text/javascript" src="../../script/mrg.js"></script>
<script type="text/javascript">
    apiready = function () {
        UpdateUserInfo();
        GetEconomy(function (dat) {
            var score = dat.score;
            if (score != undefined && score != null) {
                $api.html($api.dom('#score .infoBlockCellNum'), score);
            } else {
                api.toast({msg: '获取积分失败'});
            }
        });

        GetFavorite(function (favorite) {
            var num = favorite.questions.length + favorite.documents.length;
            var str = '我的收藏';
            if (num > 0) {
                str += '<span class="aui-badge aui-badge-danger">' + num + '</span>';
            }
            $api.html($api.dom('#favorite'), str);
        });

        GetItemNumInWrongSet(function (state, num) {
            if(state && num > 0){
                var str = '错题集' +  '<span class="aui-badge aui-badge-danger">' + num + '</span>';
                $api.html($api.dom('#wrongSet'), str);
            }
        });

        GetOwnRankAndScore(function(state, rank, score){
            $api.text($api.dom('#rank .infoBlockCellNum'), rank);
            $api.text($api.dom('#score .infoBlockCellNum'), score);
        });
    };

    function ChangePic() {
        var userInfo = $api.getStorage('userInfo');
        if (userInfo) {
            var userId = userInfo.userId;
            api.actionSheet({
                title: '从哪里更新头像?',
                cancelTitle: '取消',
                buttons: ['相册']
            }, function (ret, err) {
                if (ret.buttonIndex == 1) {
                    //打开图片
                    api.getPicture({
                        encodingType: 'jpg',
                        mediaValue: 'pic',
                        destinationType: 'url',
                        allowEdit: true,
                        quality: '50',
                        targetWidth: 100,
                        targetHeight: 100,
                        saveToPhotoAlbum: false
                    }, function (ret, err) {
                        if (ret) {
                            var url = ret.data;
                            var cachePath = api.cacheDir;
                            var path = url.split(cachePath)[1];

                            api.showProgress({
                                style: 'default',
                                animationType: 'fade',
                                title: '努力上传中...',
                                text: '先喝杯茶...'
                            });
                            var model = api.require('model');
                            model.uploadFile({
                                data: {
                                    file: {
                                        name: userId + '.jpg',
                                        url: 'cache://' + path
                                    }
                                },
                                report: false
                            }, function (ret, err) {
                                if (ret) {
                                    var id = ret.id;
                                    var name = ret.name;
                                    var url = ret.url;
                                    var avatar = {
                                        url: url,
                                        name: name,
                                        id: id
                                    };
                                    //获取原始数据
                                    model.findById({
                                        class: 'user',
                                        id: userId
                                    }, function (ret, err) {
                                        api.hideProgress();
                                        if (ret) {
                                            var oldAvatar = ret.avatar;
                                            if (oldAvatar) {
                                                //原来有头像，删除原来的头像
                                                var oldAvatarId = oldAvatar.id;
                                                model.deleteById({
                                                    class: 'file',
                                                    id: oldAvatarId
                                                });
                                            }

                                            //更新远程数据
                                            model.updateById({
                                                class: 'user',
                                                id: userId,
                                                value: {avatar: avatar}
                                            });
                                            //更新头像
                                            $api.attr($api.dom('#userHead img'), 'src', url);
                                            //更新本地数据
                                            userInfo.avatar = avatar;
                                            $api.setStorage('userInfo', userInfo);
                                            //更新侧边
                                            api.execScript({
                                                name: "fixed",
                                                script: "UpdateAvatar();"
                                            });
                                        }
                                    });
                                } else {
                                    api.hideProgress();
                                    api.alert({msg: '出错:' + JSON.stringify(err)});
                                }

                            });
                        } else if (err.msg != 'user canceled') {
                            api.alert({msg: '出错:' + JSON.stringify(err)});
                        }
                    });
                }
            });
        }
    }

    function UpdateUserInfo() {
        var userInfo = $api.getStorage('userInfo');
        if (userInfo) {
            $img = $api.dom('#userHead img');
            $nickname = $api.dom('#nickname');
            $username = $api.dom('#username');
            //更新头像
            if (userInfo.avatar) {
                $api.attr($img, 'src', userInfo.avatar.url);
            }
            else {
                $api.attr($img, 'src', '../../image/default_head.jpg');
            }
            //更新昵称
            if (userInfo.nickname) {
                $api.html($nickname, userInfo.nickname);
            }
            else {
                $api.html($nickname, '游客');
            }
            //更新用户名
            if (userInfo.username) {
                $api.html($username, userInfo.username);
            }
            else {
                $api.html($username, '');
            }
        }
    }

    //打开信息窗口
    function OpenInfoWin() {
        api.openWin({
            name: 'userInfo',
            url: '../profile/userInfo.html'
        })
    }

    //打开收藏窗口
    function OpenFavoriteWin() {
        api.openWin({
            name: 'favoriteListFrame',
            url: '../favorite/favoriteListFrame.html'
        })
    }

    //打开错题集
    function OpenWrongSet() {
        api.openWin({
            name: 'wrongSet',
            url: '../wrongSet/wrongSet.html'
        });
    }

    //切换到排行榜页面
    function SwitchToRank() {
        var $script = "ChangeWin('rank.html');";
        api.execScript({
            name: "slide",
            script: $script
        });
    }

    //登出
    function Logout() {
        var user = api.require('user');
        user.logout(function (ret, err) {
            if (ret) {
                $api.rmStorage('userInfo');
                //更新侧滑页
                api.execScript({
                    name: "fixed",
                    script: 'UpdateAvatar();'
                });
                //回到登录界面
                var $script = "ChangeWin('login.html');";
                api.execScript({
                    name: "slide",
                    script: $script
                });
            } else {
                api.alert({msg: '登出失败'})
            }
        });
    }
</script>
</html>